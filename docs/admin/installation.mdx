---
id: installation
title: Installation
sidebar_label: Installation
---

Docker Hub にて CIRCUS システムの Docker イメージを提供しています。こちらを使ってインストールするのが最も簡単です。

:::important
2022.7 現在、Mac OS では未検証です。
:::

## CIRCUS の Docker イメージ取得・初期設定

以下の手順は CIRCUS のデータフォルダを `/var/circus/data` と設定（ホストマシン、Docker コンテナ内共通）することを前提としています。

:::tip

- ホストマシンのデータフォルダを任意のフォルダに変更できます。この場合、ホストマシン と Docker コンテナの動作に影響が生じないフォルダを設定してください。
  - CIRCUS の Docker イメージでは `/var/circus` に CIRCUS のコード、設定ファイル等をインストールしています。
- ホストマシンの OS が Windows でデータフォルダを `C:\circus\data` と設定する場合、以下の `/var/circus/data` は `/c/circus/data` に置き換えてください。

:::

### Docker のインストール

CIRCUS をインストールするマシンに Docker をインストールします。詳細は [Docker 公式ドキュメント](https://docs.docker.com/get-docker/)を参考してください。

- Linux: docker-ce 19.03 以降
- Windows: Docker Desktop for Windows

### CIRCUS の Docker イメージの取得

Docker Hub より以下の Docker イメージを取得します。

```shell-session
$ sudo docker pull circuscad/circus:latest
$ sudo docker pull circuscad/dicom_utility:latest
```

:::tip

- latest は取得時点での推奨版です。対応するバージョンは予告なく変更されます。
- 長期運用時には `latest` の代わりにバージョンを指定して取得されることをお勧めします。
- Docker Hub 上にある CIRCUS の最新版は以下のサイトでご確認ください。
  - https://hub.docker.com/u/circuscad

:::

:::note

Windows のコマンドプロンプトで実行する場合は各行先頭の `sudo` は不要です（以下同様）。

:::

### 初期設定

CIRCUS システムの起動に必要なデータを作成するために以下の操作が必要となります。

1. ホストマシンに `/var/circus/data` フォルダを作成します。

1. コンテナ内部でコマンドを実行するため、CIRCUS の Docker コンテナを作成し、内部で `/bin/bash` を実行します。

   ```shell-session
   $ sudo docker run --rm -v /var/circus/data:/var/circus/data -v /var/run/docker.sock:/var/run/docker.sock -h circus -it circuscad/circus:latest
   ```

   :::note

   - 上記コマンドの最後に `/bin/bash` は不要です（コンテナ内部の初期設定スクリプトより `/bin/bash` を実行しています）。
   - `-h` オプションにより Docker コンテナのホスト名を設定してください（ここでは `circus` としていますが、別の名前でも可能です。ただし、コンテナを起動する毎にホスト名を変えた場合には正しく動作しない可能性があります）。 
   - 初期設定ではポートの公開（`-p` オプション）や IP アドレスのマッピング（`--add-host` オプション）の設定は不要です。

   :::

1. CIRCUS の Docker コンテナ 内で以下のコマンドを実行し、データベースの初期設定を行います。

   ```shell-session title="コンテナ内"
   # /circus/data_initialization.sh
   ```

1. `exit` コマンドで Docker コンテナを一旦終了させます。

## コンテナ内でのコマンドの実行 {#shell}

管理者はしばしばコンテナ内の `/bin/bash` にアクセスしてコマンドを発行する必要があります。

- データベース初期設定・マイグレーション
- プラグイン登録
- その他 CLI として提供されている各種コマンドの利用

Docker コンテナ内の Bash (`/bin/bash`) にアクセスする場合は、以下のようにします。

```shell-session
$ sudo docker run --rm -v /var/circus/data:/var/circus/data -v /var/run/docker.sock:/var/run/docker.sock -p 80:8000 -p 27017:27017 -h circus --add-host=hostmachine:[IP address for host] -it circuscad/circus:latest
```

- 上記は Linux の場合です。Windows でデータフォルダを /c/circus/data としている場合は、`-v /var/circus/data:/var/circus/data` を `-v /c/circus/data:/var/circus/data` に置き換えてください（以下同様）。
- Webサーバ (nginx) のホストマシンのポートは 8000 に設定しています。
- データベース (MongoDB) を外部から操作しない場合は `-p 27017:27017` は不要です。
- `-v /var/run/docker.sock:/var/run/docker.sock` のオプションはプラグインに Docker outside of Docker (DooD) 形式でアクセスするために必要です。
- [IP address for host] はホスト側の IP アドレスを入力します。ホスト側の IP アドレスは各 OS のコマンドなどで調べてください。以下は一例です。
  - `ip a` (Ubuntu)
  - `ipconfig` (Windows)

上記のスクリプトは Bash エイリアスなどで登録しておくと便利です。

## CRICUS の起動(初期設定後)

### コンテナ内部でコマンドを実行する場合（`/bin/bash` 経由）

上記の方法でコンテナ内の Bash にアタッチし、以下を実行します。

```shell-session title="コンテナ内"
# /circus/services.sh &
```

### デーモンとして起動させる場合

以下のコマンドで Docker コンテナをバックグラウンド起動させ、サーバ群を自動起動させることができます（上記 `/bin/bash` 経由による方法の `-it` の代わりに `-d -e DAEMON_MODE=1` とします）。

```shell-session
$ sudo docker run --rm -v /var/circus/data:/var/circus/data -v /var/run/docker.sock:/var/run/docker.sock -p 80:8000 -p 27017:27017 -h circus --add-host=hostmachine:[IP address for host] -d -e DAEMON_MODE=1 circuscad/circus:latest
```

起動させたコンテナを終了させるためには、`docker ps` コマンドで起動しているコンテナの ID を調べた上で、`docker kill --force [コンテナの ID]`を実行してください。

## 動作確認方法

1. 上記方法で CIRCUS を起動後、ホストマシンの web ブラウザで http://localhost/ （もしくはhttp://127.0.0.1/）へアクセスします。

1. ログイン画⾯が表⽰されたら、ユーザ名／パスワードともに "circus" と入力してログインしてください。

1. CIRCUS のホーム画⾯が表⽰されれば成功です。

:::warning

"circus" は管理者権限を持つ初期設定ユーザです。ログイン後、[ユーザの設定](user-settings.md) でパスワードを必ず変更してください。必要に応じて、別の管理者権限を持つユーザを作成し、そのユーザでログインし直して "circus" のログインを無効にしてください。

:::

## 新バージョンの Docker イメージを使用する場合

新バージョンの Docker イメージを使用する場合、データベースのマイグレーション処理を行う必要がある場合があります。上記の手順に従い CIRCUS の Docker コンテナ内部で CIRCUS を起動した上で、以下のコマンドを実行して内部データベースの情報の更新を行います。

```shell-session title="コンテナ内"
# cd /var/circus/packages/circus-api
# node circus migrate
```

:::warning

この操作でデータベースのリビジョンが更新された場合、旧バージョンの Docker イメージを使用することができなくなります。事前に内部データベース (MongoDB) のバックアップを取るなど、十分に注意してください。

:::

## データのバックアップ

永続的に保存されるすべてのデータはホスト側の `/var/circus/data` ディレクトリに保存されます（Linux デフォルトの場合）。このディレクトリはコンテナ作成時に `-v` オプションでコンテナにマウントされており、以下のようなデータが含まれます。

- MongoDB のデータベース（ユーザ情報、ケース情報などの非バイナリデータのほとんどを保存）
- アップロードされるシリーズデータ
- CIRCUS DB のラベルなどのバイナリデータ
- CIRCUS CS のプラグイン処理結果
- 各種実行ログデータ

バックアップは単純にこれらのファイルをコピーすることで行えます。

### 内部データベース (MongoDB) のダンプを行う場合

CIRCUS の Docker コンテナ内部で CIRCUS を起動した後、以下のコマンドを実行することで内部データベースのダンプ（バイナリバックアップ）を行えます。

```shell-session
# /circus/mongodb_dump.sh
```

上記の場合、ダンプされたデータは `/var/circus/data/mongodb_dump/circus_mongo_archive_[タイムスタンプ].gz` となります。
