---
id: installation
title: Installation
sidebar_label: Installation
---

Docker Hub にて CIRCUS システムの Docker イメージを提供しています。こちらを使ってインストールするのが最も簡単です。

:::important
2021.6 現在、Mac OS では未検証です。
:::

:::tip

Docker Hub 上にある CIRCUS の最新版は以下のサイトでご確認ください。

- https://hub.docker.com/u/circuscad

:::

## CIRCUS の Docker イメージ取得・初期設定

以下の手順は CIRCUS のデータフォルダを `/var/circus/data` と設定（ホスト、Docker コンテナ内共通）することを前提としています。

:::tip

- データフォルダを任意のフォルダに変更できます。この場合、ホストマシン と Docker コンテナの動作に影響が生じないフォルダを設定してください。
  - CIRCUS の Docker イメージでは `/var/circus` に CIRCUS のコード、設定ファイル等をインストールしています。
- ホストマシンの OS が Windows でデータフォルダを `C:\circus\data` と設定する場合、以下の `/var/circus/data` は `/c/circus/data` に置き換えてください。

:::

### Docker のインストール

CIRCUS をインストールするマシンに Docker をインストールします。詳細は [Docker 公式ドキュメント](https://docs.docker.com/get-docker/)を参考してください。

- Linux: docker-ce 19.03 以降
- Windows: Docker Desktop for Windows

### CIRCUS の Docker イメージの取得

Docker Hub より以下の Docker イメージを取得します。

```shell-session
$ sudo docker pull circuscad/circus:1.0.0-beta9
$ sudo docker pull circuscad/dicom_utility:2.0.0-beta3
```

:::note

Windows のコマンドプロンプトで実行する場合は各行先頭の `sudo` は不要です（以下同様）。

:::

### 初期設定

CIRCUS システムの起動に必要なデータを作成するために以下の操作が必要となります。

1. ホストマシンに `/var/circus/data` フォルダを作成します。

1. コンテナ内部でコマンドを実行するため、CIRCUS の Docker コンテナを作成し、内部で `/bin/bash` を実行します。

   ```shell-session
   $ sudo docker run --rm -v /var/circus/data:/var/circus/data -v /var/run/docker.sock:/var/run/docker.sock -it circuscad/circus:1.0.0-beta9
   ```

   :::note

   - 上記コマンドの最後に `/bin/bash` は不要です（コンテナ内部の初期設定スクリプトより `/bin/bash` を実行しています）。
   - 初期設定ではポートの公開（`-p` オプション）や IP アドレスのマッピング（`--add-host` オプション）の設定は不要です。

   :::

1. CIRCUS の Docker コンテナ 内で以下のコマンドを実行し、データベースの初期設定を行います。

   ```shell-session title="コンテナ内"
   # /root/data_initialize.sh
   ```

1．`exit` コマンドで Docker コンテナを一旦終了させます。

## コンテナ内でのコマンドの実行 {#shell}

管理者はしばしばコンテナ内の `/bin/bash` にアクセスしてコマンドを発行する必要があります。

- データベース初期設定・マイグレーション
- プラグイン登録
- その他 CLI として提供されている各種コマンドの利用

Docker コンテナ内の Bash (`/bin/bash`) にアクセスする場合は、以下のようにします。

```shell-session
$ sudo docker run --rm -v /var/circus/data:/var/circus/data -v /var/run/docker.sock:/var/run/docker.sock -p 80:80 -p 27017:27017 --add-host=hostmachine:[IP address for host] -it circuscad/circus:1.0.0-beta9
```

- 上記は Linux の場合です。Windows でデータフォルダを /c/circus/data としている場合は、`-v /var/circus/data:/var/circus/data` を `-v /c/circus/data:/c/circus/data` に置き換えてください（以下同様）。
- データベース (MongoDB) を外部から操作しない場合は `-p 27017:27017` は不要です。
- `-v /var/run/docker.sock:/var/run/docker.sock` のオプションはプラグインに Docker outside of Docker (DooD) 形式でアクセスするために必要です。
- [IP address for host] はホスト側の IP アドレスを入力します。ホスト側の IP アドレスは各 OS のコマンドなどで調べてください。以下は一例です。
  - `ip a` (Ubuntu)
  - `ipconfig` (Windows)

上記のスクリプトは Bash エイリアスなどで登録しておくと便利です。

## CRICUS の起動(初期設定後)

### コンテナ内部でコマンドを実行する場合（`/bin/bash` 経由）

上記の方法でコンテナ内の Bash にアタッチし、以下を実行します。

```shell-session title="コンテナ内"
# /root/services.sh &
```

### デーモンとして起動させる場合

以下のコマンドで Docker コンテナをバックグラウンド起動させ、サーバ群を自動起動させることができます（上記 `/bin/bash` 経由による方法の `-it` の代わりに `-d -e DAEMON_MODE=1` とします）。

```shell-session
$ sudo docker run --rm -v /var/circus/data:/var/circus/data -v /var/run/docker.sock:/var/run/docker.sock -p 80:80 -p 27017:27017 --add-host=hostmachine:[IP address for host] -d -e DAEMON_MODE=1 circuscad/circus:1.0.0-beta9
```

起動させたコンテナを終了させるためには、`docker ps` コマンドで起動しているコンテナの ID を調べた上で、`docker kill --force [コンテナの ID]`を実行してください。

## 新バージョンの Docker イメージを使用する場合

新バージョンの Docker イメージを使用する場合、データベースのマイグレーション処理を行う必要がある場合があります。上記の手順に従い CIRCUS の Docker コンテナ内部で CIRCUS を起動した上で、以下のコマンドを実行して内部データベースの情報の更新を行います。

```shell-session title="コンテナ内"
# cd /var/circus/packages/circus-api
# node circus migrate
```

:::warning

この操作でデータベースのリビジョンが更新された場合、旧バージョンの Docker イメージを使用することができなくなります。事前に内部データベース (MongoDB) のバックアップを取るなど、十分に注意してください。

:::

## データのバックアップ

永続的に保存されるすべてのデータはホスト側の `/var/circus/data` ディレクトリに保存されます（Linux デフォルトの場合）。このディレクトリはコンテナ作成時に `-v` オプションでコンテナにマウントされており、以下のようなデータが含まれます。

- MongoDB のデータベース（ユーザ情報、ケース情報などの非バイナリデータのほとんどを保存）
- アップロードされるシリーズデータ
- CIRCUS DB のラベルなどのバイナリデータ
- CIRCUS CS のプラグイン処理結果
- 各種実行ログデータ

バックアップは単純にこれらのファイルをコピーすることで行えます。

### 内部データベース (MongoDB) のダンプを行う場合

CIRCUS の Docker コンテナ内部で CIRCUS を起動した後、以下のコマンドを実行することで内部データベースのダンプ（バイナリバックアップ）を行えます。

```shell-session
# /root/mongodb_dump.sh
```

上記の場合、ダンプされたデータは `/var/circus/data/mongodb_dump/circus_mongo_archive_[タイムスタンプ].gz` となります。
